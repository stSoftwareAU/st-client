<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
</head>
<body bgcolor="#ffffff" text="#000000">
<H1>SyncBlock a replacement for the <font color="#3333ff">synchronized</font> keyword </H1><br>
<br>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
body {color: #000000; background-color: #ffffff; font-family: Monospaced}
table {color: #000000; background-color: #e9e8e2; font-family: Monospaced}
.ST0 {color: #969696; font-family: Monospaced; font-weight: bold}
.comment {color: #969696}
.line-number {background-color: #e9e8e2}
.character {color: #ce7b00}
.keyword-directive {color: #0000e6}
--></style>
To
prevent deadlocks we have implemented a new class called SyncBlock this
is intended as a drop in replacement of the keyword&nbsp; <br>

<br>
When you call the method <b>take()</b> on a SyncBlock object you'll
block up until the specified maximum number of seconds and then an
error will be thrown if you are unable to obtain the lock on this
object. You must ALWAYS call <b>release()</b> on any sync SyncBlock
that you have obtained the lock on. <br>
<br>
The SyncBlock differs from the keyword <font color="#3333ff">synchronized</font>
in that it is interruptible and that it will timeout if it blocks for
too long. <br>
<br>
The SyncBlock enhances a normal java.lang.concurrent.Lock in that it
will interrupt the blocking thread if it holds the lock for too long
and if the thread holding the lock is not alive a new lock object will
be created and a fatal email will be generated with the details. If a
lock fails to be obtained ( which would have been a deadlock) a fatal
email will be generated with the details of the two threads and the
blocking thread will be interrupted and the calling thread will have an
error thrown.<br>
<br>
Please see below an example of how to use, the associated test cases
and the code listing itself.<br>
<br>
<table width="100%">
  <tbody>
    <tr>
      <td align="center">com/aspc/DBObj/VirtualDB.java</td>
    </tr>
  </tbody>

</table>
<pre><span class="line-number">6686</span>     <span class="comment">/**</span>
<span class="line-number">6687</span> <span class="comment">     * </span><span
 class="comment">notify</span> <span class="comment">all</span> <span
 class="comment">the</span> <span class="comment">class</span> <span
 class="comment">listeners</span>

<span class="line-number">6688</span> <span class="comment">     * </span><span
 class="ST0">@param</span> <span class="comment">type</span> <span
 class="comment">the</span> <span class="comment">type</span> <span
 class="comment">of</span> <span class="comment">change</span> <span
 class="comment">MODIFY</span><span class="comment">,</span><span
 class="comment">DELETE</span> <span class="comment">or</span> <span
 class="comment">CREATE</span>

<span class="line-number">6689</span> <span class="comment">     * </span><span
 class="ST0">@param</span> <span class="comment">gk</span> <span
 class="comment">the</span> <span class="comment">global</span> <span
 class="comment">key</span> <span class="comment">to</span> <span
 class="comment">notify</span> <span class="comment">of</span><span
 class="comment">.</span>

<span class="line-number">6690</span>      <span class="comment">*/</span>
<span class="line-number">6691</span>     <span
 class="keyword-directive">private</span> <span
 class="keyword-directive">void</span> notifyDBClassListeners( <span
 class="keyword-directive">final</span> String type, <span
 class="keyword-directive">final</span> GlobalKey gk)
<span class="line-number">6692</span>     {
<span class="line-number">6693</span>         String key = gk.getClassId().toString();

<span class="line-number">6694</span>
<span class="line-number">6695</span>         <span class="comment">/**</span>
<span class="line-number">6696</span> <span class="comment">         * </span><span
 class="comment">DEADLOCK</span> <span class="comment">found</span> <span
 class="comment">when</span> <span class="comment">this</span> <span
 class="comment">was</span> <span class="comment">a</span> <span
 class="comment">synchronized</span> <span class="comment">block</span><span
 class="comment">.</span>

<span class="line-number">6697</span> <span class="comment">         * </span><span
 class="comment">now</span> <span class="comment">we</span> <span
 class="comment">are</span> <span class="comment">using</span> <span
 class="comment">a</span> <span class="comment">SyncBlock</span> <span
 class="comment">lock</span> <span class="comment">object</span> <span
 class="comment">which</span> <span class="comment">will</span> <span
 class="comment">timeout</span> <span class="comment">after</span><span
 class="comment"> 2 </span><span class="comment">minutes</span> <span
 class="comment">if</span> <span class="comment">not</span> <span
 class="comment">successful</span><span class="comment">.</span>

<span class="line-number">6698</span> <span class="comment">         * </span>
<span class="line-number">6699</span> <span class="comment">         * </span><span
 class="comment">Once</span> <span class="comment">you</span> <span
 class="comment">have</span> <span class="comment">taken</span> <span
 class="comment">the</span> <span class="comment">lock</span> <span
 class="comment">the</span> <span class="comment">next</span> <span
 class="comment">statement</span> <span class="comment">must</span> <span
 class="comment">be</span> <span class="comment">the</span> <span
 class="comment">start</span> <span class="comment">of</span> <span
 class="comment">the</span> <span class="comment">try</span> <span
 class="comment">block</span> <span class="comment">so</span> <span
 class="comment">we</span> <span class="comment">never</span> <span
 class="comment">leave</span> <span class="comment">this</span>

<span class="line-number">6700</span> <span class="comment">         * </span><span
 class="comment">section</span> <span class="comment">without</span> <span
 class="comment">releasing</span> <span class="comment">the</span> <span
 class="comment">lock</span><span class="comment">.</span>
<span class="line-number">6701</span>          <span class="comment">*/</span>

<span class="line-number">6702</span>         dbClassListenersLock.take();
<span class="line-number">6703</span>         <span
 class="keyword-directive">try</span>
<span class="line-number">6704</span>         {
<span class="line-number">6705</span>             ArrayList list = (ArrayList)dbClassListeners.get( key);
<span class="line-number">6706</span>
<span class="line-number">6707</span>             <span
 class="keyword-directive">if</span>(  list != <span
 class="keyword-directive">null</span>)

<span class="line-number">6708</span>             {
<span class="line-number">6709</span>                 <span
 class="keyword-directive">for</span>( <span class="keyword-directive">int</span> i = 0; i &lt; list.size(); i++)
<span class="line-number">6710</span>                 {
<span class="line-number">6711</span>                     DBClassListener listener;
<span class="line-number">6712</span>
<span class="line-number">6713</span>                     listener = (DBClassListener)list.get( i);

<span class="line-number">6714</span>
<span class="line-number">6715</span>                     <span
 class="keyword-directive">if</span>( type.equals( DBData.NOTIFY_MODIFIED))
<span class="line-number">6716</span>                     {
<span class="line-number">6717</span>                         listener.eventObjectModified( gk, <span
 class="keyword-directive">this</span>);
<span class="line-number">6718</span>                     }
<span class="line-number">6719</span>                     <span
 class="keyword-directive">else</span> <span class="keyword-directive">if</span>( type.equals( DBData.NOTIFY_DELETED))

<span class="line-number">6720</span>                     {
<span class="line-number">6721</span>                         listener.eventObjectDeleted( gk, <span
 class="keyword-directive">this</span>);
<span class="line-number">6722</span>                     }
<span class="line-number">6723</span>                     <span
 class="keyword-directive">else</span> <span class="keyword-directive">if</span>( type.equals( DBData.NOTIFY_CREATED))
<span class="line-number">6724</span>                     {
<span class="line-number">6725</span>                         listener.eventObjectCreated( gk, <span
 class="keyword-directive">this</span>);

<span class="line-number">6726</span>                     }
<span class="line-number">6727</span>                     <span
 class="keyword-directive">else</span>
<span class="line-number">6728</span>                     {
<span class="line-number">6729</span>                         LOGGER.error( <span
 class="character">"</span><span class="character">Wrong type:</span><span
 class="character">"</span> + type);
<span class="line-number">6730</span>                     }

<span class="line-number">6731</span>                 }
<span class="line-number">6732</span>             }
<span class="line-number">6733</span>         }
<span class="line-number">6734</span>         <span
 class="keyword-directive">catch</span>( Throwable t)
<span class="line-number">6735</span>         {
<span class="line-number">6736</span>             LOGGER.warn( <span
 class="character">"</span><span class="character">ignored exception in listener</span><span
 class="character">"</span>, t); <span class="comment">// Sr, 12/05/2005 Bug #5224</span>

<span class="line-number">6737</span>         }
<span class="line-number">6738</span>         <span
 class="keyword-directive">finally</span>
<span class="line-number">6739</span>         {
<span class="line-number">6740</span>             <span class="comment">/**</span>
<span class="line-number">6741</span> <span class="comment">             * </span><span
 class="comment">Always</span> <span class="comment">release</span> <span
 class="comment">the</span> <span class="comment">lock</span> <span
 class="comment">if</span> <span class="comment">obtained</span><span
 class="comment">.</span>

<span class="line-number">6742</span>              <span class="comment">*/</span>
<span class="line-number">6743</span>             dbClassListenersLock.release();
<span class="line-number">6744</span>         }
<span class="line-number">6745</span>     }
</pre>
<style type="text/css">
<!--
body {color: #000000; background-color: #ffffff; font-family: Monospaced}
table {color: #000000; background-color: #e9e8e2; font-family: Monospaced}
.ST0 {color: #969696; font-family: Monospaced; font-weight: bold}
.comment {color: #969696}
.line-number {background-color: #e9e8e2}
.character {color: #ce7b00}
.keyword-directive {color: #0000e6}
--></style>
<title>SyncBlock.java</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">

<style type="text/css">
<!--
body {color: #000000; background-color: #ffffff; font-family: Monospaced}
table {color: #000000; background-color: #e9e8e2; font-family: Monospaced}
.ST1 {color: #969696; font-family: Monospaced; font-weight: bold}
.comment {color: #969696}
.line-number {background-color: #e9e8e2}
.ST0 {color: #ce7b00; font-family: Monospaced; font-weight: bold}
.character {color: #ce7b00}
.keyword-directive {color: #0000e6}
--></style><br>
<br>
<br>
<table width="100%">
  <tbody>
    <tr>
      <td align="center">com/aspc/remote/util/misc/SyncBlock.java</td>
    </tr>
  </tbody>
</table>
<pre><span class="line-number">107</span>     <span class="comment">/**</span>

<span class="line-number">108</span> <span class="comment">     * </span><span
 class="comment">release</span> <span class="comment">the</span> <span
 class="comment">lock</span>
<span class="line-number">109</span>      <span class="comment">*/</span>
<span class="line-number">110</span>     <span class="keyword-directive">public</span> <span
 class="keyword-directive">void</span> release()

<span class="line-number">111</span>     {
<span class="line-number">112</span>         syncLock.unlock();
<span class="line-number">113</span>     }
<span class="line-number">114</span>
<span class="line-number">115</span>     <span class="comment">/**</span>
<span class="line-number">116</span> <span class="comment">     * </span><span
 class="comment">take</span> <span class="comment">the</span> <span
 class="comment">lock</span> <span class="comment">and</span> <span
 class="comment">throw</span> <span class="comment">an</span> <span
 class="comment">error</span> <span class="comment">if</span> <span
 class="comment">you</span> <span class="comment">can</span><span
 class="comment">'</span><span class="comment">t</span> <span
 class="comment">get</span> <span class="comment">it</span><span
 class="comment">.</span>

<span class="line-number">117</span>      <span class="comment">*/</span>
<span class="line-number">118</span>     <span class="keyword-directive">public</span> <span
 class="keyword-directive">void</span> take()
<span class="line-number">119</span>     {
<span class="line-number">120</span>         <span
 class="keyword-directive">try</span>
<span class="line-number">121</span>         {

<span class="line-number">122</span>             SyncLock tempLock = syncLock;
<span class="line-number">123</span>             <span
 class="keyword-directive">if</span> (syncLock.tryLock(blockSeconds, TimeUnit.SECONDS) == <span
 class="keyword-directive">false</span>)
<span class="line-number">124</span>             {
<span class="line-number">125</span>                 Thread ownerThread = syncLock.getOwner();
<span class="line-number">126</span>
<span class="line-number">127</span>                 <span
 class="keyword-directive">if</span>( ownerThread.isAlive() == <span
 class="keyword-directive">false</span>)

<span class="line-number">128</span>                 {
<span class="line-number">129</span>                     <span
 class="keyword-directive">synchronized</span>( <span
 class="keyword-directive">this</span>)
<span class="line-number">130</span>                     {
<span class="line-number">131</span>                         <span
 class="keyword-directive">if</span>( tempLock == syncLock)
<span class="line-number">132</span>                         {
<span class="line-number">133</span>                             syncLock = <span
 class="keyword-directive">new</span> SyncLock();

<span class="line-number">134</span>                         }
<span class="line-number">135</span>                     }
<span class="line-number">136</span>
<span class="line-number">137</span>                     LOGGER.fatal(<span
 class="keyword-directive">this</span> + <span class="character">"</span><span
 class="character"> never released by </span><span class="character">"</span> + ownerThread);
<span class="line-number">138</span>                     take();

<span class="line-number">139</span>                     <span
 class="keyword-directive">return</span>;
<span class="line-number">140</span>                 }
<span class="line-number">141</span>
<span class="line-number">142</span>                 StringBuilder sb = <span
 class="keyword-directive">new</span> StringBuilder( toString());
<span class="line-number">143</span>                 sb.append(<span
 class="character">"</span><span class="ST0">\n</span><span
 class="character">"</span>);

<span class="line-number">144</span>                 Thread currentThread = Thread.currentThread();
<span class="line-number">145</span>
<span class="line-number">146</span>                 sb.append(<span
 class="character">"</span><span class="character">Failed to get lock for thread: </span><span
 class="character">"</span> +  currentThread + <span class="character">"</span><span
 class="ST0">\n</span><span class="character">"</span>);

<span class="line-number">147</span>
<span class="line-number">148</span>                 <span
 class="keyword-directive">for</span> (StackTraceElement ste : currentThread.getStackTrace())
<span class="line-number">149</span>                 {
<span class="line-number">150</span>                     sb.append(<span
 class="character">"</span><span class="ST0">\t</span><span
 class="character">"</span> + ste + <span class="character">"</span><span
 class="ST0">\n</span><span class="character">"</span>);

<span class="line-number">151</span>                 }
<span class="line-number">152</span>
<span class="line-number">153</span>                 <span
 class="keyword-directive">if</span>( ownerThread != <span
 class="keyword-directive">null</span>)
<span class="line-number">154</span>                 {
<span class="line-number">155</span>                     sb.append(<span
 class="character">"</span><span class="ST0">\n</span><span
 class="character">Lock held by thread: </span><span class="character">"</span> +  ownerThread + <span
 class="character">"</span><span class="ST0">\n</span><span
 class="character">"</span>);

<span class="line-number">156</span>
<span class="line-number">157</span>                     <span
 class="keyword-directive">for</span> (StackTraceElement ste : ownerThread.getStackTrace())
<span class="line-number">158</span>                     {
<span class="line-number">159</span>                         sb.append(<span
 class="character">"</span><span class="ST0">\t</span><span
 class="character">"</span> + ste + <span class="character">"</span><span
 class="ST0">\n</span><span class="character">"</span>);

<span class="line-number">160</span>                     }
<span class="line-number">161</span>                     sb.append(<span
 class="character">"</span><span class="character">Interrupting holding thread</span><span
 class="character">"</span>);
<span class="line-number">162</span>                     ownerThread.interrupt();
<span class="line-number">163</span>                 }
<span class="line-number">164</span>                 <span
 class="keyword-directive">else</span>

<span class="line-number">165</span>                 {
<span class="line-number">166</span>                     sb.append(<span
 class="character">"</span><span class="character">NO OWNER THREAD found</span><span
 class="character">"</span>);
<span class="line-number">167</span>                 }
<span class="line-number">168</span>
<span class="line-number">169</span>                 LOGGER.fatal(sb.toString());
<span class="line-number">170</span>

<span class="line-number">171</span>                 <span
 class="keyword-directive">throw</span> <span class="keyword-directive">new</span> DataBaseError(<span
 class="character">"</span><span class="character">could not get the lock on: </span><span
 class="character">"</span> + name);
<span class="line-number">172</span>             }
<span class="line-number">173</span>         }
<span class="line-number">174</span>         <span
 class="keyword-directive">catch</span> (InterruptedException ex)

<span class="line-number">175</span>         {
<span class="line-number">176</span>             Thread.interrupted();
<span class="line-number">177</span>             LOGGER.warn( <span
 class="character">"</span><span class="character">could not take lock on </span><span
 class="character">"</span> + name, ex);
<span class="line-number">178</span>             Thread.currentThread().interrupt();
<span class="line-number">179</span>             <span
 class="keyword-directive">throw</span> <span class="keyword-directive">new</span> DataBaseError(<span
 class="character">"</span><span class="character">could not get the lock on: </span><span
 class="character">"</span> + name, ex);

<span class="line-number">180</span>         }
<span class="line-number">181</span>     }
<span class="line-number">182</span>
<span class="line-number">183</span>     <span class="keyword-directive">class</span> SyncLock <span
 class="keyword-directive">extends</span> ReentrantLock
<span class="line-number">184</span>     {
<span class="line-number">185</span>         <span
 class="keyword-directive">public</span> SyncLock( )

<span class="line-number">186</span>         {
<span class="line-number">187</span>             <span
 class="keyword-directive">super</span>( <span class="keyword-directive">true</span>);
<span class="line-number">188</span>         }
<span class="line-number">189</span>         <span class="comment">/**</span>
<span class="line-number">190</span> <span class="comment">         * </span><span
 class="comment">get</span> <span class="comment">the</span> <span
 class="comment">owner</span> <span class="comment">thread</span>

<span class="line-number">191</span> <span class="comment">         * </span><span
 class="ST1">@return</span> <span class="comment">the</span> <span
 class="comment">owner</span> <span class="comment">thread</span>
<span class="line-number">192</span>          <span class="comment">*/</span>
<span class="line-number">193</span>         @Override

<span class="line-number">194</span>         <span
 class="keyword-directive">public</span> Thread getOwner()<span
 class="comment">//NOPMD</span>
<span class="line-number">195</span>         {
<span class="line-number">196</span>             <span
 class="keyword-directive">return</span> <span class="keyword-directive">super</span>.getOwner();
<span class="line-number">197</span>         }
<span class="line-number">198</span>     }

</pre>
<br>
<br>
<br>
<br>
<table width="100%">
  <tbody>
    <tr>
      <td align="center">com/aspc/remote/util/misc/selftest/TestSyncBlock.java</td>
    </tr>
  </tbody>
</table>
<pre><span class="line-number"> 88</span>
<span class="line-number"> 89</span>     <span class="comment">/**</span>

<span class="line-number"> 90</span> <span class="comment">     * </span><span
 class="comment">check</span> <span class="comment">we</span> <span
 class="comment">recover</span> <span class="comment">from</span> <span
 class="comment">a</span> <span class="comment">lock</span> <span
 class="comment">that</span> <span class="comment">is</span> <span
 class="comment">never</span> <span class="comment">released</span><span
 class="comment">.</span>

<span class="line-number"> 91</span>      <span class="comment">*/</span>
<span class="line-number"> 92</span>     <span class="keyword-directive">public</span> <span
 class="keyword-directive">void</span> testNeverReleased() <span
 class="keyword-directive">throws</span> InterruptedException
<span class="line-number"> 93</span>     {
<span class="line-number"> 94</span>         <span
 class="keyword-directive">final</span> SyncBlock block = <span
 class="keyword-directive">new</span> SyncBlock( <span class="character">"</span><span
 class="character">never release</span><span class="character">"</span>, 2);

<span class="line-number"> 95</span>
<span class="line-number"> 96</span>         Runnable r = <span
 class="keyword-directive">new</span> Runnable( )
<span class="line-number"> 97</span>         {
<span class="line-number"> 98</span>             <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> run()
<span class="line-number"> 99</span>             {
<span class="line-number">100</span>                 block.take();

<span class="line-number">101</span>             }
<span class="line-number">102</span>         };
<span class="line-number">103</span>         Thread t = <span
 class="keyword-directive">new</span> Thread( r);
<span class="line-number">104</span>         t.start();
<span class="line-number">105</span>
<span class="line-number">106</span>         t.join( 120000);
<span class="line-number">107</span>
<span class="line-number">108</span>         block.take();

<span class="line-number">109</span>     }
<span class="line-number">110</span>
<span class="line-number">111</span>     <span class="comment">/**</span>
<span class="line-number">112</span> <span class="comment">     * </span><span
 class="comment">check</span> <span class="comment">that</span> <span
 class="comment">we</span> <span class="comment">actually</span> <span
 class="comment">do</span> <span class="comment">block</span>

<span class="line-number">113</span>      <span class="comment">*/</span>
<span class="line-number">114</span>     @SuppressWarnings(<span
 class="character">"</span><span class="character">empty-statement</span><span
 class="character">"</span>)
<span class="line-number">115</span>     <span class="keyword-directive">public</span> <span
 class="keyword-directive">void</span> testBlock() <span
 class="keyword-directive">throws</span> InterruptedException

<span class="line-number">116</span>     {
<span class="line-number">117</span>         <span
 class="keyword-directive">final</span> SyncBlock block = <span
 class="keyword-directive">new</span> SyncBlock( <span class="character">"</span><span
 class="character">long time</span><span class="character">"</span>, 10);
<span class="line-number">118</span>
<span class="line-number">119</span>         Runnable r = <span
 class="keyword-directive">new</span> Runnable( )

<span class="line-number">120</span>         {
<span class="line-number">121</span>             <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> run()
<span class="line-number">122</span>             {
<span class="line-number">123</span>                 block.take();
<span class="line-number">124</span>                 <span
 class="keyword-directive">try</span>
<span class="line-number">125</span>                 {

<span class="line-number">126</span>                     Thread.sleep(120000);
<span class="line-number">127</span>                 }
<span class="line-number">128</span>                 <span
 class="keyword-directive">catch</span> (InterruptedException ex)
<span class="line-number">129</span>                 {
<span class="line-number">130</span>                     LOGGER.warn(<span
 class="character">"</span><span class="character">interrupted</span><span
 class="character">"</span>);

<span class="line-number">131</span>                 }
<span class="line-number">132</span>                 <span
 class="keyword-directive">finally</span>
<span class="line-number">133</span>                 {
<span class="line-number">134</span>                     block.release();
<span class="line-number">135</span>                 }
<span class="line-number">136</span>             }
<span class="line-number">137</span>         };
<span class="line-number">138</span>         Thread t = <span
 class="keyword-directive">new</span> Thread( r);

<span class="line-number">139</span>         t.start();
<span class="line-number">140</span>
<span class="line-number">141</span>         t.join( 1000);
<span class="line-number">142</span>
<span class="line-number">143</span>         <span
 class="keyword-directive">try</span>
<span class="line-number">144</span>         {
<span class="line-number">145</span>             block.take();
<span class="line-number">146</span>             fail( <span
 class="character">"</span><span class="character">should not succeed</span><span
 class="character">"</span>);

<span class="line-number">147</span>         }
<span class="line-number">148</span>         <span
 class="keyword-directive">catch</span>( Throwable tw)
<span class="line-number">149</span>         {
<span class="line-number">150</span>             ;<span class="comment">// this is good</span>
<span class="line-number">151</span>         }
<span class="line-number">152</span>         t.interrupt();
<span class="line-number">153</span>

<span class="line-number">154</span>         t.join( 5000);
<span class="line-number">155</span>         block.take();
<span class="line-number">156</span>     }
<span class="line-number">157</span>
<span class="line-number">158</span>
<span class="line-number">159</span>     <span class="comment">/**</span>
<span class="line-number">160</span> <span class="comment">     * </span><span
 class="comment">check</span> <span class="comment">that</span> <span
 class="comment">deadlocks</span> <span class="comment">are</span> <span
 class="comment">handled</span>

<span class="line-number">161</span> <span class="comment">     * </span><span
 class="ST0">@throws</span> <span class="comment">Exception</span> <span
 class="comment">a</span> <span class="comment">test</span> <span
 class="comment">failure</span>
<span class="line-number">162</span>      <span class="comment">*/</span>

<span class="line-number">163</span>     <span class="keyword-directive">public</span> <span
 class="keyword-directive">void</span> testDeadlockHandled() <span
 class="keyword-directive">throws</span> Exception
<span class="line-number">164</span>     {
<span class="line-number">165</span>         a=<span
 class="keyword-directive">new</span> A();
<span class="line-number">166</span>         b=<span
 class="keyword-directive">new</span> B();

<span class="line-number">167</span>         Thread at = <span
 class="keyword-directive">new</span> Thread( a);
<span class="line-number">168</span>
<span class="line-number">169</span>         at.start();
<span class="line-number">170</span>         Thread bt = <span
 class="keyword-directive">new</span> Thread( b);
<span class="line-number">171</span>
<span class="line-number">172</span>         bt.start();
<span class="line-number">173</span>

<span class="line-number">174</span>         <span
 class="keyword-directive">long</span> start = System.currentTimeMillis();
<span class="line-number">175</span>         <span
 class="keyword-directive">while</span>( start + 120000 &gt; System.currentTimeMillis())
<span class="line-number">176</span>         {
<span class="line-number">177</span>             <span
 class="keyword-directive">if</span>( a.calling &amp;&amp; b.calling ) <span
 class="keyword-directive">break</span>;

<span class="line-number">178</span>             Thread.sleep(100);
<span class="line-number">179</span>         }
<span class="line-number">180</span>
<span class="line-number">181</span>         <span
 class="keyword-directive">synchronized</span>( marker)
<span class="line-number">182</span>         {
<span class="line-number">183</span>             marker.notifyAll();
<span class="line-number">184</span>         }
<span class="line-number">185</span>         LOGGER.info(<span
 class="character">"</span><span class="character">waiting for detection</span><span
 class="character">"</span>);

<span class="line-number">186</span>         at.join(240000);
<span class="line-number">187</span>         bt.join(240000);
<span class="line-number">188</span>
<span class="line-number">189</span>         <span
 class="keyword-directive">if</span>( a.theException == <span
 class="keyword-directive">null</span> &amp;&amp; b.theException == <span
 class="keyword-directive">null</span>)
<span class="line-number">190</span>         {

<span class="line-number">191</span>             fail( <span
 class="character">"</span><span class="character">The threads were not interrupted</span><span
 class="character">"</span>);
<span class="line-number">192</span>         }
<span class="line-number">193</span>
<span class="line-number">194</span>         assertFalse( <span
 class="character">"</span><span class="character">should have finished</span><span
 class="character">"</span>,  at.isAlive());

<span class="line-number">195</span>         assertFalse( <span
 class="character">"</span><span class="character">should have finished</span><span
 class="character">"</span>,  bt.isAlive());
<span class="line-number">196</span>     }
<span class="line-number">197</span>
<span class="line-number">198</span>     <span class="keyword-directive">class</span> A <span
 class="keyword-directive">implements</span> Runnable

<span class="line-number">199</span>     {
<span class="line-number">200</span>         <span
 class="keyword-directive">private</span> <span
 class="keyword-directive">final</span> SyncBlock block = <span
 class="keyword-directive">new</span> SyncBlock(<span class="character">"</span><span
 class="character">A block</span><span class="character">"</span>, 2);
<span class="line-number">201</span>         <span
 class="keyword-directive">boolean</span> calling;

<span class="line-number">202</span>         Throwable theException;
<span class="line-number">203</span>
<span class="line-number">204</span>         <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> run()
<span class="line-number">205</span>         {
<span class="line-number">206</span>             <span
 class="keyword-directive">try</span>
<span class="line-number">207</span>             {

<span class="line-number">208</span>                 callB();
<span class="line-number">209</span>             }
<span class="line-number">210</span>             <span
 class="keyword-directive">catch</span>( Throwable e)
<span class="line-number">211</span>             {
<span class="line-number">212</span>                 theException = e;
<span class="line-number">213</span>                 LOGGER.warn( <span
 class="character">"</span><span class="character">got cancelled</span><span
 class="character">"</span>, e);

<span class="line-number">214</span>             }
<span class="line-number">215</span>         }
<span class="line-number">216</span>
<span class="line-number">217</span>         <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> hello()
<span class="line-number">218</span>         {
<span class="line-number">219</span>             block.take();
<span class="line-number">220</span>             <span
 class="keyword-directive">try</span>

<span class="line-number">221</span>             {
<span class="line-number">222</span>                 LOGGER.info(<span
 class="character">"</span><span class="character">hello A</span><span
 class="character">"</span>);
<span class="line-number">223</span>             }
<span class="line-number">224</span>             <span
 class="keyword-directive">finally</span>
<span class="line-number">225</span>             {

<span class="line-number">226</span>                 block.release();
<span class="line-number">227</span>             }
<span class="line-number">228</span>         }
<span class="line-number">229</span>
<span class="line-number">230</span>         <span
 class="keyword-directive">private</span> <span
 class="keyword-directive">void</span> callB() <span
 class="keyword-directive">throws</span> InterruptedException
<span class="line-number">231</span>         {

<span class="line-number">232</span>             block.take();
<span class="line-number">233</span>             <span
 class="keyword-directive">try</span>
<span class="line-number">234</span>             {
<span class="line-number">235</span>                 calling=<span
 class="keyword-directive">true</span>;
<span class="line-number">236</span>                 <span
 class="keyword-directive">synchronized</span>( marker)
<span class="line-number">237</span>                 {

<span class="line-number">238</span>                     marker.wait(120000);
<span class="line-number">239</span>                 }
<span class="line-number">240</span>                 LOGGER.info(<span
 class="character">"</span><span class="character">call B</span><span
 class="character">"</span>);
<span class="line-number">241</span>                 b.hello();
<span class="line-number">242</span>             }
<span class="line-number">243</span>             <span
 class="keyword-directive">finally</span>

<span class="line-number">244</span>             {
<span class="line-number">245</span>                 block.release();
<span class="line-number">246</span>             }
<span class="line-number">247</span>         }
<span class="line-number">248</span>     }
<span class="line-number">249</span>
<span class="line-number">250</span>     <span class="keyword-directive">class</span> B <span
 class="keyword-directive">implements</span> Runnable

<span class="line-number">251</span>     {
<span class="line-number">252</span>         <span
 class="keyword-directive">boolean</span> calling;
<span class="line-number">253</span>         Throwable theException;
<span class="line-number">254</span>         <span
 class="keyword-directive">private</span> <span
 class="keyword-directive">final</span> SyncBlock block = <span
 class="keyword-directive">new</span> SyncBlock(<span class="character">"</span><span
 class="character">A block</span><span class="character">"</span>, 2);

<span class="line-number">255</span>
<span class="line-number">256</span>         <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> run()
<span class="line-number">257</span>         {
<span class="line-number">258</span>             <span
 class="keyword-directive">try</span>
<span class="line-number">259</span>             {
<span class="line-number">260</span>                 callA();

<span class="line-number">261</span>             }
<span class="line-number">262</span>             <span
 class="keyword-directive">catch</span>( Throwable e)
<span class="line-number">263</span>             {
<span class="line-number">264</span>                 theException = e;
<span class="line-number">265</span>                 LOGGER.warn( <span
 class="character">"</span><span class="character">got cancelled</span><span
 class="character">"</span>, e);

<span class="line-number">266</span>             }
<span class="line-number">267</span>         }
<span class="line-number">268</span>
<span class="line-number">269</span>         <span
 class="keyword-directive">public</span> <span class="keyword-directive">void</span> hello()
<span class="line-number">270</span>         {
<span class="line-number">271</span>             block.take();
<span class="line-number">272</span>             <span
 class="keyword-directive">try</span>

<span class="line-number">273</span>             {
<span class="line-number">274</span>                 LOGGER.info(<span
 class="character">"</span><span class="character">hello B</span><span
 class="character">"</span>);
<span class="line-number">275</span>             }
<span class="line-number">276</span>             <span
 class="keyword-directive">finally</span>
<span class="line-number">277</span>             {

<span class="line-number">278</span>                 block.release();
<span class="line-number">279</span>             }
<span class="line-number">280</span>         }
<span class="line-number">281</span>
<span class="line-number">282</span>         <span
 class="keyword-directive">private</span> <span
 class="keyword-directive">void</span> callA() <span
 class="keyword-directive">throws</span> InterruptedException
<span class="line-number">283</span>         {

<span class="line-number">284</span>             block.take();
<span class="line-number">285</span>             <span
 class="keyword-directive">try</span>
<span class="line-number">286</span>             {
<span class="line-number">287</span>                 calling=<span
 class="keyword-directive">true</span>;
<span class="line-number">288</span>                 <span
 class="keyword-directive">synchronized</span>( marker)
<span class="line-number">289</span>                 {

<span class="line-number">290</span>                     marker.wait(120000);
<span class="line-number">291</span>                 }
<span class="line-number">292</span>                 LOGGER.info(<span
 class="character">"</span><span class="character">call A</span><span
 class="character">"</span>);
<span class="line-number">293</span>                 a.hello();
<span class="line-number">294</span>             }
<span class="line-number">295</span>             <span
 class="keyword-directive">finally</span>

<span class="line-number">296</span>             {
<span class="line-number">297</span>                 block.release();
<span class="line-number">298</span>             }
<span class="line-number">299</span>         }
<span class="line-number">300</span>     }
<span class="line-number">301</span>
<span class="line-number">302</span>     <span class="keyword-directive">private</span> A a;
<span class="line-number">303</span>     <span class="keyword-directive">private</span> B b;</pre>

</body>
</html>
