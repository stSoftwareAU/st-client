<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>Known methods to lose JMS messages ( cause out of sync) </TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Unix)">
	<META NAME="CREATED" CONTENT="20090527;9153600">
	<META NAME="CHANGED" CONTENT="20090528;10540500">
	<META NAME="Info 1" CONTENT="">
	<META NAME="Info 2" CONTENT="">
	<META NAME="Info 3" CONTENT="">
	<META NAME="Info 4" CONTENT="">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 0.79in }
		P { margin-bottom: 0.08in }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<P ALIGN=CENTER><U><B>KNOW METHODS OF LOSING/SLOW (or out of order) MESSAGES v8a</B></U></P>
<OL type="A">
    <LI>interrupt exception closes any and
	all sockets including JMS, pending messages
	will not be sent to the server. 
	</LI>
    <LI>System.exit will lose any pending
	messages to be sent 
	</LI>
    <LI>kill -9 will lose any pending
	messages to be sent 
	</LI>
        <LI style="text-decoration: line-through;"> inactivity time-out ( was 30
	seconds) now disabled
	</LI>
    <LI>broken JMS bridge
	</LI>
    <LI>JMS disabled.</LI>
    <LI>Restarting of the JMS server causes pending messages for the
	client to be lost</LI>
    <LI>No guarantee that messages come in the order that they were created. ie.
        transaction 212,479,500 could be received before 212,479,498 if they are generated by
        two different programs or if the transactions have unique set of records. The
        transaction number for a record will always increase. The transactions are received
        from one program in the order that program set them. We have many programs so
        transactions come in mixed order. Also transactions take different amounts of time to
        save so they aren't sent in the same order as the transaction number.</LI>
    <LI>Records can be loaded or searched before the transaction that created
        them is received. This can lead to impossible situations where a child
        exists before the parent does</LI>
    <LI>Very long GC will may cause very slow messages. If the large GC is on the application
        that saved the transaction this can lead to out of sync issues.
	</LI>
    <LI>Server hotspot crash may cause lost of any pending messages to be sent </LI>
</OL>
<P ALIGN=CENTER><U><B>CURRENT DESIGN</B></U></P>
<UL>
	<LI><P>The save of records to the database and the sending of the
	JMS message is <FONT COLOR="#cc0000">*NOT*</FONT> ACID. 
	</P>
	<LI><P>The write of records to the database is ACID so either all of
	the changes (including the transaction header) are written to the
	database or none of them are. 
	</P>
	<LI><P>JMS is very fast way of notify other systems of changes in
	most cases &lt; 2 ms with no database hit at all.</P>
	<LI><P>If we interrupt the saving thread we can cause the database
	changes to be saved but no message sent out. It's just a matter of
	timing.</P>
	<LI><P>If no message is sent out then the system maybe be out of
	sync. Unless we implement something like #10374</P>
	<LI><P>MDE does use process cancel or job timeout a lot which does
	do an interrupt on a thread that is saving. 
	</P>
</UL>
<P><BR><BR>
The way to handle H & I is to check that we have received the transaction for the Job via JMS and if not load this transaction and other transactions not yet received.

The transactions from a system are received in the same order that they are sent ( mixed with other servers) if we haven't received the transaction for the job then we also haven't received other messages also ( maybe in the queue), we can use this as a single to load from the transaction header.

</P>
<P>I've created a benchmark script that has many subscribers and some
of these subscribers are made to be very slow on a few messages ie 10
minutes to process a message( to simulate large GC). The messages
sent are very large and randomly generated so that the compression
doesn't work too well. With this configuration I can cause timeouts
and therefore lost of messages.</P>
<P><BR><BR>
</P>
<P>The large pauses caused JMS connections to be lost and therefore
lost of messages. I turned off the inactivity monitoring for all the
subscribers and this prevent the connections from being closed BUT if
the backlog of messages got too large the publishers had timeout
errors when they when to close the connection. Now I can work around
this issue by setting the connection to NOT send a-synchronize
messages but wait for each message to be delivered before sending
another see below:-<BR><BR><BR>BUT turning off async sending of
messages really slows down the publishing. This would greatly effect
MarketServer. <BR><BR><BR>
</P>
<P STYLE="margin-bottom: 0in">The fault tolerant of missing messages
maybe the best work around.</P>
<P><BR><BR>
</P>
<P>The first timeout is the inactivity monitor which is easy enough
to turn off with no side effects that I can see but the second
timeout is on the closing of the publisher. This is because the
messages are still banked up on the publisher side. Changing the
publisher not to publish in an asynchronise manner really slows down
the publishing but prevents this timeout.&nbsp; 
</P>
<P><BR><BR>
</P>
<P>I do recommend the increasing or disabling of the inactivity
timeout but sending messages in a synchronized manner is too costly
from what I can see, better solution is this fall back strategy of
periodically scanning the trans_header table as this is a perfect
copy of the jms messages and the scan will not add any additional
load on the system if the message has already been received except
for the select from the transaction table itself. The only real
question is how often do we scan the table ? Remember whichever
frequency we choose will be multiplied by the number of servers. 
</P>
<P><BR><BR>
</P>
<P>We need to make sure that&nbsp; batch programs don't&nbsp; just do
a System.exit as this will cause the lost of messages.</P>
<P><BR><BR>
</P>
</BODY>
</HTML>